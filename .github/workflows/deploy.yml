name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout files repository
        uses: actions/checkout@v2

      - name: Set up SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}

      - name: Update app files on cloud 
        uses: easingthemes/ssh-deploy@v2
        with:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SSH_PASSWORD: ${{ secrets.REMOTE_PASSWORD }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SOURCE: ../../../
          TARGET: /home/ec2-user/nto-web-spa
          
      - name: Copy SSH key to server
        uses: easingthemes/ssh-deploy@v2
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cat ${{ secrets.SSH_PRIVATE_KEY }} >> ~/.ssh/authorized_keys
            chmod 600 ~/.ssh/authorized_keys
            chmod 700 ~/.ssh

      - name: Check if Docker is installed
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            if ! command -v docker &> /dev/null; then
              echo "Docker is not installed"
              INSTALL_DOCKER=true
            else
              echo "Docker is already installed"
              INSTALL_DOCKER=false
            fi

      - name: Install Docker on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          if: ${{ steps.check-docker.outputs.INSTALL_DOCKER == 'true' }}
          script: |
            sudo apt-get update
            sudo apt-get install -y docker.io
      
      - name: Build and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            pwd
            ls
            DEPLOY_PATH=$(find /home/ec2-user/nto-web-spa -name "Deploy.sh" -type f)
            echo "Found Deploy.sh at: $DEPLOY_PATH"
            sh "$DEPLOY_PATH"